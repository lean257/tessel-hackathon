"use strict";function e(e){var t=this;t.options=e||{},t.proxyOptions=t.options.proxy||{},t.maxSockets=t.options.maxSockets||n.Agent.defaultMaxSockets,t.requests=[],t.sockets=[],t.on("free",function(e,o,r){var s,n,c;for(s=0,n=t.requests.length;s<n;++s)if((c=t.requests[s]).host===o&&c.port===r)return t.requests.splice(s,1),void c.request.onSocket(e);e.destroy(),t.removeSocket(e)})}function t(t,r){var n=this;e.prototype.createSocket.call(n,t,function(e){var t=s.connect(0,o({},n.options,{socket:e}));r(t)})}function o(e){var t,o,r,s,n,c,u;for(t=1,o=arguments.length;t<o;++t)if("object"==typeof(r=arguments[t]))for(n=0,c=(s=Object.keys(r)).length;n<c;++n)void 0!==r[u=s[n]]&&(e[u]=r[u]);return e}require("net");var r,s=require("tls"),n=require("http"),c=require("https"),u=require("events"),i=require("assert"),a=require("util");exports.httpOverHttp=function(t){var o=new e(t);return o.request=n.request,o},exports.httpsOverHttp=function(o){var r=new e(o);return r.request=n.request,r.createSocket=t,r},exports.httpOverHttps=function(t){var o=new e(t);return o.request=c.request,o},exports.httpsOverHttps=function(o){var r=new e(o);return r.request=c.request,r.createSocket=t,r},a.inherits(e,u.EventEmitter),e.prototype.addRequest=function(e,t,o){var r=this;r.sockets.length>=this.maxSockets?r.requests.push({host:t,port:o,request:e}):r.createSocket({host:t,port:o,request:e},function(s){function n(){r.emit("free",s,t,o)}function c(){r.removeSocket(),s.removeListener("free",n),s.removeListener("close",c),s.removeListener("agentRemove",c)}s.on("free",n),s.on("close",c),s.on("agentRemove",c),e.onSocket(s)})},e.prototype.createSocket=function(e,t){function s(o,s,n){if(c.removeAllListeners(),s.removeAllListeners(),200===o.statusCode)i.equal(n.length,0),r("tunneling connection has established"),u.sockets[u.sockets.indexOf(a)]=s,t(s);else{r("tunneling socket could not be established, statusCode=%d",o.statusCode);var p=Error("tunneling socket could not be established, sutatusCode="+o.statusCode);p.code="ECONNRESET",e.request.emit("error",p),u.removeSocket(a)}}var n,c,u=this,a={};u.sockets.push(a),(n=o({},u.proxyOptions,{method:"CONNECT",path:e.host+":"+e.port,agent:!1})).proxyAuth&&(n.headers=n.headers||{},n.headers["Proxy-Authorization"]="Basic "+new Buffer(n.proxyAuth).toString("base64")),r("making CONNECT request"),(c=u.request(n)).useChunkedEncodingByDefault=!1,c.once("response",function(e){e.upgrade=!0}),c.once("upgrade",function(e,t,o){process.nextTick(function(){s(e,t,o)})}),c.once("connect",s),c.once("error",function(t){c.removeAllListeners(),r("tunneling socket could not be established, cause=%s\n",t.message,t.stack);var o=Error("tunneling socket could not be established, cause="+t.message);o.code="ECONNRESET",e.request.emit("error",o),u.removeSocket(a)}),c.end()},e.prototype.removeSocket=function(e){var t,o=this.sockets.indexOf(e);-1!==o&&(this.sockets.splice(o,1),(t=this.requests.shift())&&this.createSocket(t,function(e){t.request.onSocket(e)}))},r=process.env.NODE_DEBUG&&/\btunnel\b/.test(process.env.NODE_DEBUG)?function(){var e=Array.prototype.slice.call(arguments);"string"==typeof e[0]?e[0]="TUNNEL: "+e[0]:e.unshift("TUNNEL:"),console.error.apply(console,e)}:function(){},exports.debug=r;