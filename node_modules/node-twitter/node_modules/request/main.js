function e(e){return new Buffer(e||"","ascii").toString("base64")}function t(e){if(e.readable&&e.path&&e.mode)return!0}function r(e){var t={};return Object.keys(e).forEach(function(r){t[r]=e[r]}),t}function o(e){var t,i;m.Stream.call(this),this.readable=!0,this.writable=!0,"string"==typeof e&&(e={uri:e}),t=Object.keys(o.prototype);for(i in e)-1===t.indexOf(i)?this[i]=e[i]:"function"==typeof e[i]&&delete e[i];e=r(e),this.init(e)}function i(e,t,r){return"function"!=typeof t||r||(r=t),t&&"object"==typeof t?t.uri=e:"string"==typeof e?t={uri:e}:e=(t=e).uri,{uri:e,options:t,callback:r}}function n(e,t,r){if(void 0===e)throw Error("undefined is not a valid uri or options object.");return"function"!=typeof t||r||(r=t),t&&"object"==typeof t?t.uri=e:t="string"==typeof e?{uri:e}:e,r&&(t.callback=r),new o(t)}function s(e,t){var r,o,i,n;for("object"!=typeof e&&"function"!=typeof e||(r={}),Array.isArray(e)&&(r=[]),o=[],Object.defineProperty(e,t,{}),i=Object.keys(e).filter(function(r){return r!==t&&("object"!=typeof e[r]&&"function"!=typeof e[r]||null===e[r]||!Object.getOwnPropertyDescriptor(e[r],t))}),n=0;n<i.length;n++)"object"!=typeof e[i[n]]&&"function"!=typeof e[i[n]]||null===e[i[n]]?r[i[n]]=e[i[n]]:(o.push(i[n]),Object.defineProperty(e[i[n]],t,{}));for(n=0;n<o.length;n++)r[o[n]]=s(e[o[n]],t);return r}function a(){return s(this,(65536*(1+Math.random())|0).toString(16))}var u,h,p,d=require("http"),c=!1,l=!1,f=require("url"),y=require("util"),m=require("stream"),b=require("querystring"),g=require("./mimetypes"),w=require("./oauth"),_=require("./uuid"),k=require("./forever"),q=require("./vendor/cookie"),v=require("./vendor/cookie/jar"),E=new v,T=require("./tunnel"),j=require("./aws");process.logging&&(u=process.logging("request"));try{c=require("https")}catch(e){}try{l=require("tls")}catch(e){}c&&!c.Agent&&(c.Agent=function(e){d.Agent.call(this,e)},y.inherits(c.Agent,d.Agent),c.Agent.prototype._getConnection=function(e,t,r){return l.connect(t,e,this.options,function(){r&&r()})}),h=/^https?:/,p={},y.inherits(o,m.Stream),o.prototype.init=function(o){var i,n,s,a,u,h,l,y,m,w=this;if(o||(o={}),w.pool||!1===w.pool||(w.pool=p),w.dests=[],w.__isRequestRequest=!0,!w._callback&&w.callback&&(w._callback=w.callback,w.callback=function(){w._callbackCalled||(w._callback.apply(w,arguments),w._callbackCalled=!0)},w.on("error",w.callback.bind()),w.on("complete",w.callback.bind(w,null))),w.url&&(w.uri=w.url,delete w.url),!w.uri)throw Error("options.uri is a required argument");if("string"==typeof w.uri&&(w.uri=f.parse(w.uri)),w.proxy&&("string"==typeof w.proxy&&(w.proxy=f.parse(w.proxy)),d.globalAgent&&"https:"===w.uri.protocol&&(w.tunnel=!0,i="http:"===w.proxy.protocol?T.httpsOverHttp:T.httpsOverHttps,n={proxy:{host:w.proxy.hostname,port:+w.proxy.port,proxyAuth:w.proxy.auth},ca:this.ca},w.agent=i(n),w.tunnel=!0)),!w.uri.host||!w.uri.pathname)return s=f.format(w.uri),a='Invalid URI "'+s+'"',0===Object.keys(o).length&&(a+=". This can be caused by a crappy redirection."),void w.emit("error",Error(a));if(w._redirectsFollowed=w._redirectsFollowed||0,w.maxRedirects=void 0!==w.maxRedirects?w.maxRedirects:10,w.followRedirect=void 0===w.followRedirect||w.followRedirect,w.followAllRedirects=void 0!==w.followAllRedirects&&w.followAllRedirects,(w.followRedirect||w.followAllRedirects)&&(w.redirects=w.redirects||[]),w.headers=w.headers?r(w.headers):{},w.setHost=!1,w.headers.host||(w.headers.host=w.uri.hostname,w.uri.port&&(80===w.uri.port&&"http:"===w.uri.protocol||443===w.uri.port&&"https:"===w.uri.protocol||(w.headers.host+=":"+w.uri.port)),w.setHost=!0),w.jar(w._jar||o.jar),w.uri.pathname||(w.uri.pathname="/"),w.uri.port||("http:"==w.uri.protocol?w.uri.port=80:"https:"==w.uri.protocol&&(w.uri.port=443)),w.proxy&&!w.tunnel?(w.port=w.proxy.port,w.host=w.proxy.hostname):(w.port=w.uri.port,w.host=w.uri.hostname),w.clientErrorHandler=function(e){if(!w._aborted){if(w.setHost&&delete w.headers.host,w.req._reusedSocket&&"ECONNRESET"===e.code&&w.agent.addRequestNoreuse)return w.agent={addRequest:w.agent.addRequestNoreuse.bind(w.agent)},w.start(),void w.req.end();w.timeout&&w.timeoutTimer&&(clearTimeout(w.timeoutTimer),w.timeoutTimer=null),w.emit("error",e)}},o.form&&w.form(o.form),o.oauth&&w.oauth(o.oauth),o.aws&&w.aws(o.aws),w.uri.auth&&!w.headers.authorization&&(w.headers.authorization="Basic "+e(w.uri.auth.split(":").map(function(e){return b.unescape(e)}).join(":"))),w.proxy&&w.proxy.auth&&!w.headers["proxy-authorization"]&&!w.tunnel&&(w.headers["proxy-authorization"]="Basic "+e(w.proxy.auth.split(":").map(function(e){return b.unescape(e)}).join(":"))),o.qs&&w.qs(o.qs),w.uri.path?w.path=w.uri.path:w.path=w.uri.pathname+(w.uri.search||""),0===w.path.length&&(w.path="/"),w.proxy&&!w.tunnel&&(w.path=w.uri.protocol+"//"+w.uri.host+w.path),o.json?w.json(o.json):o.multipart&&(w.boundary=_(),w.multipart(o.multipart)),w.body){if(u=0,Buffer.isBuffer(w.body))u=w.body.length;else if(Array.isArray(w.body))for(h=0;h<w.body.length;h++)u+=w.body[h].length;else w.body=new Buffer(w.body),u=w.body.length;if(!u)throw Error("Argument error, options.body.");w.headers["content-length"]=u}if(l=w.proxy&&!w.tunnel?w.proxy.protocol:w.uri.protocol,y={"http:":d,"https:":c},m=w.httpModules||{},w.httpModule=m[l]||y[l],!w.httpModule)throw Error("Invalid protocol");o.ca&&(w.ca=o.ca),w.agent||(o.agentOptions&&(w.agentOptions=o.agentOptions),o.agentClass?w.agentClass=o.agentClass:o.forever?w.agentClass="http:"===l?k:k.SSL:w.agentClass=w.httpModule.Agent),!1===w.pool?w.agent=!1:(w.agent=w.agent||w.getAgent(),w.maxSockets&&(w.agent.maxSockets=w.maxSockets),w.pool.maxSockets&&(w.agent.maxSockets=w.pool.maxSockets)),w.once("pipe",function(e){if(w.ntick)throw Error("You cannot pipe to this stream after the first nextTick() after creation of the request stream.");if(w.src=e,t(e))w.headers["content-type"]||w.headers["Content-Type"]||(w.headers["content-type"]=g.lookup(e.path.slice(e.path.lastIndexOf(".")+1)));else{if(e.headers)for(var r in e.headers)w.headers[r]||(w.headers[r]=e.headers[r]);e.method&&!w.method&&(w.method=e.method)}w.on("pipe",function(){console.error("You have already piped to this stream. Pipeing twice is likely to break the request.")})}),process.nextTick(function(){w._aborted||(w.body?(Array.isArray(w.body)?w.body.forEach(function(e){w.write(e)}):w.write(w.body),w.end()):w.requestBodyStream?(console.warn("options.requestBodyStream is deprecated, please pass the request object to stream.pipe."),w.requestBodyStream.pipe(w)):w.src||("GET"!==w.method&&void 0!==w.method&&(w.headers["content-length"]=0),w.end()),w.ntick=!0)})},o.prototype.getAgent=function(){var e,t,r=this.agentClass,o={};if(this.agentOptions)for(e in this.agentOptions)o[e]=this.agentOptions[e];return this.ca&&(o.ca=this.ca),t="",r!==this.httpModule.Agent&&(t+=r.name),this.httpModule.globalAgent||(o.host=this.host,o.port=this.port,t&&(t+=":"),t+=this.host+":"+this.port),o.ca&&(t&&(t+=":"),t+=o.ca),!t&&r===this.httpModule.Agent&&this.httpModule.globalAgent?this.httpModule.globalAgent:this.pool[t]?this.pool[t]:this.pool[t]=new r(o)},o.prototype.start=function(){var e=this;e._aborted||(e._started=!0,e.method=e.method||"GET",e.href=e.uri.href,u&&u("%method %href",e),e.src&&e.src.stat&&e.src.stat.size&&(e.headers["content-length"]=e.src.stat.size),e._aws&&e.aws(e._aws,!0),e.req=e.httpModule.request(e,function(t){var r,o,i,n;if(!e._aborted){if(e._paused&&t.pause(),e.response=t,t.request=e,t.toJSON=a,e.httpModule===c&&e.strictSSL&&!t.client.authorized)return r=t.client.authorizationError,void e.emit("error",Error("SSL Error: "+r));if(e.setHost&&delete e.headers.host,e.timeout&&e.timeoutTimer&&(clearTimeout(e.timeoutTimer),e.timeoutTimer=null),o=function(t){e._jar?e._jar.add(new q(t)):E.add(new q(t))},t.headers["set-cookie"]&&!e._disableCookies&&(Array.isArray(t.headers["set-cookie"])?t.headers["set-cookie"].forEach(o):o(t.headers["set-cookie"])),t.statusCode>=300&&t.statusCode<400&&(e.followAllRedirects||e.followRedirect&&"PUT"!==e.method&&"POST"!==e.method&&"DELETE"!==e.method)&&t.headers.location)return e._redirectsFollowed>=e.maxRedirects?void e.emit("error",Error("Exceeded maxRedirects. Probably stuck in a redirect loop.")):(e._redirectsFollowed+=1,h.test(t.headers.location)||(t.headers.location=f.resolve(e.uri.href,t.headers.location)),e.uri=t.headers.location,e.redirects.push({statusCode:t.statusCode,redirectUri:t.headers.location}),e.followAllRedirects&&(e.method="GET"),delete e.req,delete e.agent,delete e._started,delete e.body,e.headers&&delete e.headers.host,u&&u("Redirect to %uri",e),void e.init());e._redirectsFollowed=e._redirectsFollowed||0,t.on("close",function(){e._ended||e.response.emit("end")}),e.encoding&&(0!==e.dests.length?console.error("Ingoring encoding parameter as this stream is being piped to another stream which makes the encoding option invalid."):t.setEncoding(e.encoding)),e.dests.forEach(function(t){e.pipeDest(t)}),t.on("data",function(t){e._destdata=!0,e.emit("data",t)}),t.on("end",function(t){e._ended=!0,e.emit("end",t)}),t.on("close",function(){e.emit("close")}),e.emit("response",t),e.callback&&(i=[],n=0,e.on("data",function(e){i.push(e),n+=e.length}),e.on("end",function(){var r,o;if(!e._aborted){if(i.length&&Buffer.isBuffer(i[0])?(r=new Buffer(n),o=0,i.forEach(function(e){e.copy(r,o,0,e.length),o+=e.length}),null===e.encoding?t.body=r:t.body=""+r):i.length&&(t.body=i.join("")),e._json)try{t.body=JSON.parse(t.body)}catch(e){}e.emit("complete",t,t.body)}}))}}),e.timeout&&!e.timeoutTimer&&(e.timeoutTimer=setTimeout(function(){e.req.abort();var t=Error("ETIMEDOUT");t.code="ETIMEDOUT",e.emit("error",t)},e.timeout),e.req.setTimeout&&e.req.setTimeout(e.timeout,function(){if(e.req){e.req.abort();var t=Error("ESOCKETTIMEDOUT");t.code="ESOCKETTIMEDOUT",e.emit("error",t)}})),e.req.on("error",e.clientErrorHandler),e.req.on("drain",function(){e.emit("drain")}),e.emit("request",e.req))},o.prototype.abort=function(){this._aborted=!0,this.req?this.req.abort():this.response&&this.response.abort(),this.emit("abort")},o.prototype.pipeDest=function(e){var t,r=this.response;if(e.headers&&(e.headers["content-type"]=r.headers["content-type"],r.headers["content-length"]&&(e.headers["content-length"]=r.headers["content-length"])),e.setHeader){for(t in r.headers)e.setHeader(t,r.headers[t]);e.statusCode=r.statusCode}this.pipefilter&&this.pipefilter(r,e)},o.prototype.setHeader=function(e,t,r){return void 0===r&&(r=!0),r||!this.headers.hasOwnProperty(e)?this.headers[e]=t:this.headers[e]+=","+t,this},o.prototype.setHeaders=function(e){for(var t in e)this.setHeader(t,e[t]);return this},o.prototype.qs=function(e,t){var r,o;r=!t&&this.uri.query?b.parse(this.uri.query):{};for(o in e)r[o]=e[o];return this.uri=f.parse(this.uri.href.split("?")[0]+"?"+b.stringify(r)),this.url=this.uri,this},o.prototype.form=function(e){return this.headers["content-type"]="application/x-www-form-urlencoded; charset=utf-8",this.body=b.stringify(e).toString("utf8"),this},o.prototype.multipart=function(e){var t=this;if(t.body=[],t.headers["content-type"]?t.headers["content-type"]=t.headers["content-type"].split(";")[0]+"; boundary="+t.boundary:t.headers["content-type"]="multipart/related; boundary="+t.boundary,console.log("boundary >> "+t.boundary),!e.forEach)throw Error("Argument error, options.multipart.");return e.forEach(function(e){var r,o=e.body;if(null==o)throw Error("Body attribute missing in multipart.");delete e.body,r="--"+t.boundary+"\r\n",Object.keys(e).forEach(function(t){r+=t+": "+e[t]+"\r\n"}),r+="\r\n",t.body.push(new Buffer(r)),t.body.push(new Buffer(o)),t.body.push(new Buffer("\r\n"))}),t.body.push(new Buffer("--"+t.boundary+"--")),t},o.prototype.json=function(e){return this.setHeader("content-type","application/json"),this.setHeader("accept","application/json"),this._json=!0,"boolean"==typeof e?"object"==typeof this.body&&(this.body=JSON.stringify(this.body)):this.body=JSON.stringify(e),this},o.prototype.aws=function(e,t){if(!t)return this._aws=e,this;var r=new Date;return this.setHeader("date",r.toUTCString()),this.setHeader("authorization",j.authorization({key:e.key,secret:e.secret,verb:this.method,date:r,resource:j.canonicalizeResource("/"+e.bucket+this.path),contentType:this.headers["content-type"]||"",md5:this.headers["content-md5"]||"",amazonHeaders:j.canonicalizeHeaders(this.headers)})),this},o.prototype.oauth=function(e){var t,r,o,i,n,s,a;this.headers["content-type"]&&"application/x-www-form-urlencoded"===this.headers["content-type"].slice(0,33)&&(t=b.parse(this.body)),this.uri.query&&(t=b.parse(this.uri.query)),t||(t={}),r={};for(o in t)r[o]=t[o];for(o in e)r["oauth_"+o]=e[o];r.oauth_version||(r.oauth_version="1.0"),r.oauth_timestamp||(r.oauth_timestamp=""+Math.floor((new Date).getTime()/1e3)),r.oauth_nonce||(r.oauth_nonce=_().replace(/-/g,"")),r.oauth_signature_method="HMAC-SHA1",i=r.oauth_consumer_secret,delete r.oauth_consumer_secret,n=r.oauth_token_secret,delete r.oauth_token_secret,s=this.uri.protocol+"//"+this.uri.host+this.uri.pathname,a=w.hmacsign(this.method,s,r,i,n);for(o in t)o.slice(0,"oauth_")in e||delete r["oauth_"+o];return this.headers.Authorization="OAuth "+Object.keys(r).sort().map(function(e){return e+'="'+w.rfc3986(r[e])+'"'}).join(","),this.headers.Authorization+=',oauth_signature="'+w.rfc3986(a)+'"',this},o.prototype.jar=function(e){var t,r;return 0===this._redirectsFollowed&&(this.originalCookieHeader=this.headers.cookie),!1===e?(t=!1,this._disableCookies=!0):t=e?e.get({url:this.uri.href}):E.get({url:this.uri.href}),t&&t.length&&(r=t.map(function(e){return e.name+"="+e.value}).join("; "),this.originalCookieHeader?this.headers.cookie=this.originalCookieHeader+"; "+r:this.headers.cookie=r),this._jar=e,this},o.prototype.pipe=function(e,t){if(this.response){if(this._destdata)throw Error("You cannot pipe after data has been emitted from the response.");if(this._ended)throw Error("You cannot pipe after the response has been ended.");return m.Stream.prototype.pipe.call(this,e,t),this.pipeDest(e),e}return this.dests.push(e),m.Stream.prototype.pipe.call(this,e,t),e},o.prototype.write=function(){return this._started||this.start(),this.req.write.apply(this.req,arguments)},o.prototype.end=function(e){e&&this.write(e),this._started||this.start(),this.req.end()},o.prototype.pause=function(){this.response?this.response.pause.apply(this.response,arguments):this._paused=!0},o.prototype.resume=function(){this.response?this.response.resume.apply(this.response,arguments):this._paused=!1},o.prototype.destroy=function(){this._ended||this.end()},module.exports=n,n.defaults=function(e){var t=function(t){return function(r,o,n){var s,a=i(r,o,n);for(s in e)void 0===a.options[s]&&(a.options[s]=e[s]);return t(a.options,a.callback)}},r=t(n);return r.get=t(n.get),r.post=t(n.post),r.put=t(n.put),r.head=t(n.head),r.del=t(n.del),r.cookie=t(n.cookie),r.jar=t(n.jar),r},n.forever=function(e,t){var r={};if(t)for(option in t)r[option]=t[option];return e&&(r.agentOptions=e),r.forever=!0,n.defaults(r)},n.get=n,n.post=function(e,t,r){var o=i(e,t,r);return o.options.method="POST",n(o.uri||null,o.options,o.callback)},n.put=function(e,t,r){var o=i(e,t,r);return o.options.method="PUT",n(o.uri||null,o.options,o.callback)},n.head=function(e,t,r){var o=i(e,t,r);if(o.options.method="HEAD",o.options.body||o.options.requestBodyStream||o.options.json&&"boolean"!=typeof o.options.json||o.options.multipart)throw Error("HTTP HEAD requests MUST NOT include a request body.");return n(o.uri||null,o.options,o.callback)},n.del=function(e,t,r){var o=i(e,t,r);return o.options.method="DELETE",n(o.uri||null,o.options,o.callback)},n.jar=function(){return new v},n.cookie=function(e){if(e&&e.uri&&(e=e.uri),"string"!=typeof e)throw Error("The cookie function only accepts STRING as param");return new q(e)},o.prototype.toJSON=a;