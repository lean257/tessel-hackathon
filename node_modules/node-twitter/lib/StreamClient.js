var t=require("util"),e=require("./Client"),i=require("./Constants"),r=function(t,r,o,n){e.call(this,t,r,o,n),this._apiBaseUrlString=i.StreamApiBaseURLString,this._apiVersion=i.StreamApiVersion};t.inherits(r,e),r.prototype.isRunning=function(){var t=this;return Object.keys(t._connections).length>=1},r.prototype.start=function(t,e,i,r,o){if(!0===this.isRunning())throw Error("StreamClient is currently running.");var n={};if(void 0!==t&&null!==t){if(!(t instanceof Array))throw Error("Expected Array object.");n.track=t.join(",")}if(void 0!==e&&null!==e){if(!(e instanceof Array))throw Error("Expected Array object.");n.locations=e.join(",")}if(void 0!==i&&null!==i){if(!(i instanceof Array))throw Error("Expected Array object.");n.follow=i.join(",")}if(void 0!==r&&null!==r){if(!1!==isNaN(r))throw Error("Expected integer.");n.count=r}t||e||i||r?this._createPostRequest("statuses/filter","json",n):this._createGetRequest("statuses/sample","json",n),o&&"function"==typeof o&&o(null,"tweet")},r.prototype.stop=function(t){var e,i,r,o=this;for(e in this._connections)void 0===(i=this._connectionForKey(e))&&delete o._connections[e],i.httpRequest.req.abort();t&&"function"==typeof t&&(r=function(){o.isRunning()?setTimeout(r,100):t(null,"tweet")})()},r.prototype._requestDidClose=function(t){e.prototype._requestDidClose.call(this,t),this.emit("close")},r.prototype._requestDidEnd=function(t){e.prototype._requestDidEnd.call(this,t),this.emit("end")},r.prototype._requestDidFailWithError=function(t,i){e.prototype._requestDidFailWithError.call(this,t,i),this.emit("error",i)},r.prototype._requestDidReceiveData=function(t,e){var r,o,n,s=this._connectionForKey(t.hash);if(void 0!==s)for(s.data=s.data+e.toString("utf8"),r=-1;-1!==(r=s.data.indexOf(i.StreamApiObjectTerminator));)if(o=s.data.slice(0,r),s.data=s.data.slice(r+i.StreamApiObjectTerminator.length),0!==o.length){n=void 0;try{n=JSON.parse(o)}catch(t){n=void 0,this.emit("error",t)}void 0!==n&&(void 0!==n.delete?this.emit("deleteTweet",n.delete):void 0!==n.scrub_geo?this.emit("deleteLocation",n.scrub_geo):void 0!==n.limit?this.emit("limit",n.limit):void 0!==n.retweeted_status?this.emit("retweet",n.retweeted_status):this.emit("tweet",n))}},module.exports=r;