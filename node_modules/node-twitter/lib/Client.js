var e=require("crypto"),t=require("events"),o=require("request"),s=require("querystring"),i=function(e,o,s,i){t.EventEmitter.call(this),this._apiBaseUrlString=null,this._apiVersion=null,this._oauth={consumer_key:e,consumer_secret:o,token:s,token_secret:i},this._connections={}};require("util").inherits(i,t.EventEmitter),i.prototype.oauth=function(){return this._oauth},i.prototype._connectionForKey=function(e){return this._connections[e]},i.prototype._createGetRequest=function(t,i,n,a){var r,c,h,u=this._apiBaseUrlString+"/";null!==this._apiVersion&&(u+=this._apiVersion+"/"),u+=t+"."+i,void 0!==(r=s.stringify(n))&&null!==r&&r.length>0&&(u=u+"?"+r),c={method:"GET",url:u,oauth:this.oauth()},(h=o.get(c)).hash=e.createHash("sha1").update(JSON.stringify(h.headers),"utf8").digest("hex"),this._connections[h.hash]={callback:a,data:"",httpRequest:h},this._createEventListenersForRequest(h)},i.prototype._createPostRequest=function(t,s,i,n){var a,r,c=this._apiBaseUrlString+"/";null!==this._apiVersion&&(c+=this._apiVersion+"/"),a={method:"POST",url:c+=t+"."+s,oauth:this.oauth(),form:i},(r=o.post(a)).hash=e.createHash("sha1").update(JSON.stringify(r.headers),"utf8").digest("hex"),this._connections[r.hash]={callback:n,data:"",httpRequest:r},this._createEventListenersForRequest(r)},i.prototype._createEventListenersForRequest=function(e){var t=this;e.on("close",function(){t._requestDidClose(e)}),e.on("data",function(o){t._requestDidReceiveData(e,o)}),e.on("end",function(){t._requestDidEnd(e)}),e.on("error",function(o){t._requestDidFailWithError(e,o)}),e.on("response",function(o){t._requestDidReceiveResponse(e,o)})},i.prototype._removeConnectionForKey=function(e){void 0!==this._connectionForKey(e)&&delete this._connections[e]},i.prototype._requestDidClose=function(e){var t,o,s=this._connectionForKey(e.hash);if(void 0!==s){t=void 0,o=void 0;try{o=JSON.parse(s.data)}catch(e){t=e,o=void 0}s.callback instanceof Function&&s.callback(t,o),this._removeConnectionForKey(e.hash)}},i.prototype._requestDidEnd=function(e){var t,o,s=this._connectionForKey(e.hash);if(void 0!==s){t=void 0,o=void 0;try{o=JSON.parse(s.data)}catch(e){t=e,o=void 0}s.callback instanceof Function&&s.callback(t,o),this._removeConnectionForKey(e.hash)}},i.prototype._requestDidFailWithError=function(e,t){var o=this._connectionForKey(e.hash);void 0!==o&&(o.callback instanceof Function&&o.callback(t,void 0),this._removeConnectionForKey(e.hash))},i.prototype._requestDidReceiveData=function(e,t){var o,s=this._connectionForKey(e.hash);void 0!==s&&(o=s.data+t.toString("utf8"),s.data=o)},i.prototype._requestDidReceiveResponse=function(e,t){var o,s=this._connectionForKey(e.hash);switch(void 0!==s&&(s.data=""),o=null,200!==t.statusCode&&((o=Error()).code=t.statusCode),t.statusCode){case 304:o.message="Not Modified.";break;case 400:o.message="Bad Request";break;case 401:o.message="Unauthorized";break;case 403:o.message="Forbidden";break;case 404:o.message="Not Found";break;case 429:o.message="Too Many Requests";break;case 406:o.message="Not Acceptable";break;case 420:o.message="Enhance Your Calm";break;case 500:o.message="Internal Server Error";break;case 502:o.message="Bad Gateway";break;case 503:o.message="Service Unavailable"}null===o||this._requestDidFailWithError(e,o)},module.exports=i;